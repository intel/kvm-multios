# Table of Contents
1. [Automated Android VM Installation](#automated-android-vm-installation)
    1. [Prerequisites](#prerequisites)
        1. [Celadon Build](#celadon-build)
            1. [Setup Build Environment](#setup-build-environment)
            1. [Setup Celadon workspace](#setup-celadon-workspace)
            1. [Running Android Celadon IoT Build](#running-android-celadon-iot-build)
                1. [Celadon IoT vertical Android12 Build](#celadon-iot-vertical-android12-build)
    1. [Running Android Celadon Automated Install](#running-android-celadon-automated-install)
1. [Launching Android VM](#launching-android-vm)
1. [Basic Android VM operations](#basic-android-vm-operations)

# Automated Android VM Installation
The automated Android VM automated installation will perform the following:
- setup host for all Android VM required dependency services and host configuration
- install Intel Celadon Android from release file archive

## Prerequisites
Required:
Obtain Celadon releasefiles archive package caas-releasefiles-*.tar.gz as per Intel IoT platform release package.
This is usually generated by:
- Sync from Celadon manifest for Android release as per Intel IoT platform release package and [build from source](#celadon-build)

Host platform DUT setup:
- Host platform is setup as per platform release BSP guide and booted accordingly.
- Host platform has network connection and Internet access and proxy variables (http_proxy, https_proxy, no_proxy) are set appropriately in /etc/environment if required for network access.
- Host platform has Internet apt access. ie. Running "sudo apt update" worked successfully.
- Host platform date/time is set up properly to current date/time.
- Host platform is already setup for using KVM MultiOS Portfolio release as per instructions [here](README.md#host-setup).

### Celadon Build
#### Setup Build environment
An Ubuntu 18.04 build environment is needed.
Refer to Celadon development setup for instructions: https://projectceladon.github.io/celadon-documentation/getting-started/build-source.html#

***Additional setup notes:***
1. Create symbolic link for Python ***if and only if ‘/usr/bin/python’ does not already exist*** 

   Note: if using Python3, please ensure installed version on development machine meets version as required in Celadon development setup prerequisites.  

           $ sudo ln -sf /usr/bin/python3 /usr/bin/python

2. Git config needs to be setup on Celadon build machine prior to syncing Celadon workspace from Github.  
   Reference: https://git-scm.com/book/en/v2/Getting-Started-First-Time-Git-Setup

        $ git config --global user.name "John Doe"
        $ git config --global user.email johndoe@example.com

        Where:
        change "John Doe" to your name
        change johndoe@example.com to your email

    If build machine network is behind proxy, also config proxy accordingly for git.

            $ git config --global http.proxy http://proxyuser:proxypwd@proxy.server.com:8080
            $ git config --global https.proxy http://proxyuser:proxypwd@proxy.server.com:8080

            Where:
            change proxyuser to your proxy user (if required)
            change proxypwd to your proxy password (if required)
            If no proxy user/password is required, remove "proxyuser:proxypwd@" portion of url.
            change proxy.server.com to the URL of your proxy server
            change 8080 to the proxy port configured on your proxy server

    To check current git proxy settings:

            $ git config --global --get http.proxy
            $ git config --global --get https.proxy

3. Install python-six module

        sudo apt install python-six

#### Setup Celadon workspace
Obtain Android Celadon IoT manifest xml file as per platform release. Please contact Intel customer representative for Andriod Celadon IoT release manifest as released for the platform.

***Note: Android Celadon IoT manifest xml would be like Vertical_CIV_aa.bb.cc.dd_Axx.xml where aa.bb.cc.dd is the release version and Axx is the Android version such as A12, A13 etc. Do take note to use corresponding build instuctions based on Android version.*** 

***Additional setup notes:***
Sync Android Celadon IoT release as per manifest xml provided in platform KVM MultiOS release package. This will take some time depending on network conditions.  

        mkdir civ
        cd civ
        repo init -u https://github.com/projectceladon/manifest -b master
        cp <manifest.xml> .repo/manifests/
        repo init -m <manifest.xml>

        repo sync -c -j8
        repo forall -c git lfs pull

#### Running Android Celadon IoT Build  
##### Celadon IoT vertical Android12 Build  
Run the following commands in Celadon workspace to build for Celadon IoT Android 12 release.

For all Celadon IoT vertical Android12 releases:  

        cd civ
        source build/envsetup.sh
        lunch caas-userdebug
        make flashfiles BASE_LTS2020_YOCTO_KERNEL=true -j8

After successful build, required build output releasefiles archive can be located from build workspace as per example below:

        $ find pub -name caas-releasefiles*.tar.gz
        pub/caas/userdebug/caas-releasefiles-userdebug.tar.gz

## Running Android Celadon Automated Install

**Note: all provided Android VM XMLs in KVM MultiOS Libvirt Portfolio  release assumes Android VM domain is named as "android".
To use another VM domain name, use "--dupxml" option to create new duplicate xmls for the new domain (if not already created before)**

        ./guest_setup/ubuntu/android_setup.sh -p client -r <path to caas-releasefiles-userdebug.tar.gz> --forceclean

The default storage size of the Android VM created is 40 GiB. To customize the size of the Android VM, add the option --disk-size <size in GiB>

        ./guest_setup/ubuntu/android_setup.sh -p client -r <path to caas-releasefiles-userdebug.tar.gz> --forceclean --disk-size <size in GiB>

Command reference:

        android_setup.sh [-h] [-f] [-n] [-p] [-r] [-t] [--disk-size] [--noinstall] [--forceclean] [--dupxml] [--qemufromsrc]
        Installs Celadon system dependencies and create android vm images from CIV releasefiles archive to dest folder /var/lib/libvirt/images/<vm_domain_name>
        Options:
                -h            Show this help message
                -r            Celadon releasefiles archive file. "-r caas-releasefiles-userdebug.tar.gz". If option is present, any existing dest folder will be deleted.
                -t            Dest folder to decompress releasefiles archive into. Default: "-t ./caas-releasefiles"
                -f            Celadon flashfiles zip archive file. "Default is auto set to caas-flashfiles-xxxx.zip as found in dest folder specified by -t option"
                -n            Android vm libvirt domain name. Default: "-n android"
                -p            specific platform to setup for, eg. "-p client "
                              Accepted values:
                                client
                                server
                --disk-size   Disk storage size of Android vm in GiB, default is 40 GiB
                --noinstall   Only rebuild Android per vm required images and data output. Needs folder specified by -t option to be present and with valid contents.
                --forceclean  Delete android VM dest folder if exists. Default not enabled
                --dupxml      Duplicate Android guest XM xmls for this VM (when not using "-n android")
                --qemufromsrc Rebuild qemu from source and install (overwrites existing platform BSP installation. Do not use if unsure.)
                --suspend     Enable Android autosuspend


This script will decompress provided caas-releasefiles-userdebug.tar.gz and create all necessary Celadon VM image file and other data/executable files into /var/lib/libvirt/images/<vm_domain_name> folder.

If the host platform already has installed required Android dependencies before, "--noinstall" option could be used to skip installation steps.  
If creating multiple VMs from the same caas-releasefiles-*.tar.gz archive package, '-r' option could be left out to skip archive package decompression and reuse earlier releasefiles decompressed folder for 2nd and beyond VM image creation.  
Use "--dupxml" option for duplicating new Android VM libvirt xml for non-default name (aka not named "android").  

Android VM installation will be automatically started by setup script using once VM images have been created by running the <vm_name>_install domain.

Once <vm_name>_install VM start running, Celadon installer will automatically run to install CiV to VM storage.
There is no VM display during Android image flashing to VM.

**<vm_name>_install VM automatically exits upon installation completion**.

To view Android flashing progress in console, run:

        sudo virsh console <vm_name>_install

Android flashing console log can be found at /var/log/libvirt/qemu/<vm_name>-install-serial0.log

# Launching Android VM
Android VM can be started with different display support as per below examples.
Refer to [VM Management](README.md#vm-management) for more details on VM managment.
**Note: Due Android OS design, not all typical VM management methods could be used with Android VM. See [Basic Android VM operations](#basic-android-vm-operations)**

<table>
    <tr><th align="center">Example</th><th>Description</th></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -g sriov android</td><td>To force launch android guest VM configured with SR-IOV display</td></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -g gvtd android</td><td>To force launch android guest VM configured with GVT-d display</td></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -p android --usb keyboard</td><td>To android and passthrough USB Keyboard to android guest VM</td></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -p android --pci wi-fi</td><td>To force launch android VM and passthrough PCI WiFi to android guest VM</td></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -p android --pci network controller 2</td><td>To force launch android VM and passthrough the 2nd PCI Network Controller in lspci list to android guest VM</td></tr>
    <tr><td rowspan="1">./platform/xxxx/launch_multios.sh -f -d android -p android --xml xxxx.xml</td><td>To force launch android VM and passthrough the device(s) in the XML file to android guest VM</td></tr>
</table>

# Basic Android VM operations
Connect to Android VM via ADB
**Default for <vm_name> is "android". Replace with VM domain name created if different.**

        sudo virsh domifaddr android
         Name       MAC address          Protocol     Address
        -------------------------------------------------------------------------------
        vnet26     52:54:00:ab:cd:33    ipv4         192.168.122.33/24

        adb connect 192.168.122.33:5555
        connected to 192.168.122.33:5555

        adb devices
        List of devices attached
        192.168.122.33:5555     device

Setup proxy for Android

        adb shell
        caas:/ # su
        caas:/ # settings put global http_proxy <proxy_url>:<proxy_port>

Clear proxy for Android

        adb shell
        caas:/ # su
        caas:/ # settings put global http_proxy null

Shutdown Android via ADB

        adb reboot -p
